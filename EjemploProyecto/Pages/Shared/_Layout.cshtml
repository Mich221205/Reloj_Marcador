@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    var nombre = HttpContextAccessor.HttpContext?.Session.GetString("Nombre") ?? "Invitado";
    var apellido1 = HttpContextAccessor.HttpContext?.Session.GetString("Apellido1") ?? "";
    var apellido2 = HttpContextAccessor.HttpContext?.Session.GetString("Apellido2") ?? "";
    var rolUsuario = HttpContextAccessor.HttpContext?.Session.GetString("RolUsuario") ?? "Invitado";
    var avatarUrl = HttpContextAccessor.HttpContext?.Session.GetString("AvatarUrl") ?? "/images/avatar.png";
    var nombreCompleto = $"{nombre} {apellido1} {apellido2}".Trim();
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Siempre Puntuales S.A.</title>

    <!-- Estilos -->
    <link rel="stylesheet" href="~/css/bienvenida.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
</head>

<script>
    (function () {
        //const INACTIVITY_TIME = 5 * 60 * 1000; // 5 minutos
        const INACTIVITY_TIME = 10 * 1000; // 5 minutos
        let timer;

        function resetTimer() {
            clearTimeout(timer);
            timer = setTimeout(showSessionExpiredModal, INACTIVITY_TIME);
        }

        function showSessionExpiredModal() {
            const modalElement = document.getElementById('sessionExpiredModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            // Cuando el usuario presione el botón, redirigir al login
            const redirectButton = document.getElementById('redirectLoginBtn');
            redirectButton.addEventListener('click', function () {
                window.location.href = '/ADM_Login/Login?expired=1';
            });
        }

        // Escuchar actividad del usuario para reiniciar el contador
        ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(event =>
            document.addEventListener(event, resetTimer, true)
        );

        resetTimer();
    })();
</script>

<body>
    <!-- Encabezado superior -->
    <header class="header">
        <div class="header-left">
            <img src="~/images/LOGO.ico" alt="Logo de Siempre Puntuales S.A." class="header-logo" />
            <strong>Siempre Puntuales S.A.</strong>
        </div>

        <div class="header-right">
            <span>@nombreCompleto</span>
            <img src="~/images/avatar.png" alt="Avatar" />
        </div>
    </header>

    <!-- Menú lateral dinámico según el rol -->
    <aside class="sidebar">
        <h6 class="text-center text-uppercase">@rolUsuario</h6>
        <hr class="border-light" />

        <ul class="sidebar-menu">
            <li>
                <a class="sidebar-link" asp-page="/ADM_Login/Bienvenida">
                    <i class="bi bi-house"></i> Home
                </a>
            </li>


            <li>
                <a class="sidebar-link" asp-page="/ADM_Usuarios/Index">
                    <i class="bi bi-people"></i> Usuarios
                </a>
            </li>

            <li>
                <a class="sidebar-link" asp-page="/ADM_Ausencias/Index">
                    <i class="bi bi-calendar-x"></i> Motivos Ausencias
                </a>
            </li>

            <li>
                <a class="sidebar-link" asp-page="/Roles/Index">
                    <i class="bi bi-person-badge"></i> Roles
                </a>
            </li>

            <li>
                <a class="sidebar-link" asp-page="/TiposIdentificacion/Index">
                    <i class="bi bi-card-list"></i> Tipos Identificación
                </a>
            </li>

            <li>
                <a class="sidebar-link" asp-page="/InconsistenciasM/Index">
                    <i class="bi bi-exclamation-triangle"></i> Inconsistencias
                </a>
            </li>
        </ul>

        <hr class="border-light" />

        <a href="/ADM_Login/Login" class="sidebar-link logout">
            <i class="bi bi-box-arrow-left"></i> Cerrar Sesión
        </a>
    </aside>

    <!-- Modal de sesión vencida -->
    <div class="modal fade" id="sessionExpiredModal" tabindex="-1" aria-labelledby="sessionExpiredLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger shadow-lg">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="sessionExpiredLabel">Sesión vencida</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    Tu sesión ha expirado por inactividad.<br />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="redirectLoginBtn">Aceptar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Contenido principal -->
    <main class="main-content">
        <div class="container mt-4">
            @RenderBody()
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>